{% extends "base.html" %}
{% block content %}
<h1>Interaction</h1>

<!-- NPC's last spoken dialogue -->
<div class="border p-3 mb-3 bg-light" style="white-space: pre-line;">
  <strong>NPC says:</strong> {{ npc_spoken_dialogue }}
</div>

<!-- USER ACTION form -->
<form method="POST" class="mb-4">
  <label class="form-label">Your Action (in-game):</label>
  <input type="text" class="form-control mb-2" name="user_action" placeholder="e.g. 'He quietly asks about her day...'">
  <button type="submit" name="submit_action" class="btn btn-success">
    Submit Action
  </button>
</form>

<hr>
<h3>Update Environment / Clothing</h3>
<form method="POST" class="row g-3 mb-4">
  <div class="col-md-6">
    <label class="form-label">New Environment</label>
    <select class="form-select" name="new_environment">
      <option value="">(No change)</option>
      {% for envopt in environment_options %}
        <option value="{{ envopt }}">{{ envopt }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-6">
    <label class="form-label">New Clothing</label>
    <select class="form-select" name="new_clothing">
      <option value="">(No change)</option>
      {% for copt in clothing_options %}
        <option value="{{ copt }}">{{ copt }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-12">
    <button type="submit" name="update_mutable" value="true" class="btn btn-warning">
      Update NPC
    </button>
  </div>
</form>

<hr>

<!-- SCENE IMAGE PROMPT & GENERATION -->
<h3>Generate Scene Prompt</h3>
<p>Click this button to ask the LLM for a single-sentence prompt referencing the NPC's environment, personality, last behavior, etc.</p>
<form method="POST">
  <button type="submit" name="generate_scene_image" class="btn btn-primary">
    Generate Scene Prompt
  </button>
</form>

{% if scene_image_prompt %}
  <hr>
  <h4>Scene Prompt</h4>
  <p>You can refine this prompt below before generating the final image.</p>
  <form method="POST">
    <textarea name="scene_image_prompt" rows="3" class="form-control">{{ scene_image_prompt }}</textarea>
    <div class="mt-3">
      <button type="submit" name="do_generate_flux" class="btn btn-success me-2">
        Generate Scene Image
      </button>
      <button type="submit" name="same_seed" class="btn btn-secondary me-2">
        Generate (Same Seed)
      </button>
      <button type="submit" name="new_seed" class="btn btn-warning me-2">
        Generate (New Seed)
      </button>
    </div>
  </form>
{% endif %}

{% if scene_image_url %}
  <hr>
  <h4>Generated Scene Image</h4>
  <img src="{{ url_for('view_image') }}" alt="Scene Image" style="max-width:60%;">
  {% if scene_image_seed %}
    <p class="mt-2">Seed: {{ scene_image_seed }}</p>
  {% endif %}
{% endif %}

<hr>
<h4>Story Log</h4>
<div class="border p-3 bg-light" style="white-space: pre-line; font-size: 1rem;">
  {% for entry in interaction_log %}
    {{ entry }}
  {% endfor %}
</div>

<hr>
<h4>Relationship Stats</h4>
<ul>
  <li>Affection Score: {{ affection_score }}</li>
  <li>Trust Score: {{ trust_score }}</li>
  <li>NPC Mood: {{ npc_mood }}</li>
  <li>Current Stage: {{ current_stage }} ({{ stage_label }})</li>
  <li>Stage Description: {{ stage_desc }}</li>
  <li>Next Stage Threshold: {{ next_threshold }}</li>
</ul>

<hr>
<h4>NPC Private Thoughts (Debug)</h4>
<p style="white-space: pre-line;">{{ npc_private_thoughts }}</p>

<hr>
<h4>Dice Debug</h4>
<p>Dice Roll: {{ dice_roll_dbg }}</p>
<p>Outcome: {{ dice_outcome_dbg }}</p>

<hr>
<a href="{{ url_for('restart') }}" class="btn btn-outline-secondary">Restart Entire Story</a>
{% endblock %}