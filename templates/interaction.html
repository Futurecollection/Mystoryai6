{% extends "base.html" %}

{% block content %}
<!-- New top-left button linking to the full story page -->
<div class="row mb-3">
  <div class="col text-start">
    <a href="{{ url_for('full_story') }}" class="btn btn-info">
      Full Narration
    </a>
  </div>
  <div class="col text-end">
    <!-- (Optionally put something on the top-right, or leave blank) -->
  </div>
</div>

<h1 style="color: #ff5789;">Interaction</h1>

<!-- Scene / NARRATION from gpt-4o-mini -->
<div class="border p-3 mb-3" style="white-space: pre-line; background-color: #4a0d0d; color: #f8d0d0;">
  <strong>Scene:</strong> {{ npc_narration }}
</div>

<!-- USER ACTION -->
<form method="POST" class="mb-4">
  <label class="form-label" style="color: #f8d0d0;">Your Move (in-game):</label>
  <input type="text" class="form-control mb-2" name="user_action" 
         placeholder="He quietly asks how she's doing...">
  <button type="submit" name="submit_action" class="btn btn-success">
    Send Move
  </button>
  <div style="color: #f8d0d0; font-size: 0.9em; display: block; margin-top: 5px; line-height: 1.4;">
    <strong>To begin a premade bio story or continue the scene:</strong> Simply press Send Move with an empty text box<br>
    <strong>To give scene directions (OOC commands):</strong> Start your message with "OOC:" followed by your request. Examples:<br>
    • "OOC: Can we have more dialogue from [character name]"<br>
    • "OOC: That last scene felt rushed, can we slow it down and add more detail"<br>
    • "OOC: Let's make the scene more romantic/playful/intense"<br>
    • "OOC: Can we focus more on the emotional connection"<br>
    • "OOC: The previous narration didn't quite fit, can we adjust it to be more [specific request]"
  </div>
</form>

<hr style="border-top: 1px solid #ff5789;">
<!-- SCENE IMAGE PROMPT -->
<h3 style="color: #ff5789;">Scene Image Prompt</h3>
<form method="POST" class="mb-3">
  <div class="mb-2">
    <button type="submit" name="generate_scene_prompt" class="btn btn-secondary me-3">
      Generate Scene Prompt
    </button>
    <small style="color: #f8d0d0;">Auto generate prompt referencing NPC & environment</small>
  </div>

  <textarea name="scene_image_prompt" rows="2" class="form-control" style="background-color: #4a0d0d; color: #f8d0d0;">{{ scene_image_prompt }}</textarea>
  <div class="mt-3">
    <button type="submit" name="do_generate_flux" class="btn btn-primary me-2">
      Generate Scene Image
    </button>
    <button type="submit" name="new_seed" class="btn btn-warning">
      New Seed
    </button>
  </div>
</form>

{% if scene_image_url %}
  <hr style="border-top: 1px solid #ff5789;">
  <h4 style="color: #ff5789;">Generated Scene Image</h4>
  <img src="{{ url_for('view_image') }}" alt="Scene Image" style="max-width:60%;">
  {% if scene_image_seed %}
    <p class="mt-2" style="color: #f8d0d0;">Seed: {{ scene_image_seed }}</p>
  {% endif %}
{% endif %}

<hr style="border-top: 1px solid #ff5789;">
<!-- AFFECTION OVERRIDE -->
<form method="POST" class="mb-4">
  <label class="form-label" style="color: #f8d0d0;">Override Affection Score:</label>
  <input type="number" step="0.1" class="form-control mb-2" 
         name="affection_new" value="{{ affection_score }}">
  <button type="submit" name="update_affection" class="btn btn-info">
    Update Affection
  </button>
</form>

<hr style="border-top: 1px solid #ff5789;">
<!-- Stage Unlocks Button -->
<div class="row mb-3">
  <div class="col-12">
    <a href="{{ url_for('stage_unlocks') }}" class="btn btn-warning">
      Edit Stage Unlocks
    </a>
  </div>
</div>

<hr style="border-top: 1px solid #ff5789;">
<!-- Mid-Game Personalization Button -->
<div class="row mb-3">
  <div class="col-12">
    <a href="{{ url_for('mid_game_personalize') }}" class="btn btn-warning">
      Update Character & Environment
    </a>
  </div>
</div>

<hr style="border-top: 1px solid #ff5789;">
<a href="{{ url_for('restart') }}" class="btn btn-outline-secondary">
  Restart Entire Story
</a>
{% endblock %}