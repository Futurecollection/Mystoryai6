{% extends "base.html" %}
{% block content %}
<h1>Interaction</h1>

<!-- Scene / NARRATION from gpt-4o-mini -->
<div class="border p-3 mb-3" style="white-space: pre-line;">
  <strong>Scene:</strong> {{ npc_narration }}
</div>

<!-- USER ACTION -->
<form method="POST" class="mb-4">
  <label class="form-label">Your Move (in-game):</label>
  <input type="text" class="form-control mb-2" name="user_action" 
         placeholder="He quietly asks how sheâ€™s doing...">
  <button type="submit" name="submit_action" class="btn btn-success">
    Send Move
  </button>
</form>

<hr>
<!-- SCENE IMAGE PROMPT -->
<h3>Scene Image Prompt</h3>
<form method="POST" class="mb-3">
  <div class="mb-2">
    <button type="submit" name="generate_scene_prompt" class="btn btn-secondary me-3">
      Generate Scene Prompt
    </button>
    <small>Auto generate prompt referencing NPC & environment</small>
  </div>

  <textarea name="scene_image_prompt" rows="2" class="form-control">{{ scene_image_prompt }}</textarea>
  <div class="mt-3">
    <button type="submit" name="do_generate_flux" class="btn btn-primary me-2">
      Generate Scene Image
    </button>
    <button type="submit" name="new_seed" class="btn btn-warning">
      New Seed
    </button>
  </div>
</form>

{% if scene_image_url %}
  <hr>
  <h4>Generated Scene Image</h4>
  <img src="{{ url_for('view_image') }}" alt="Scene Image" style="max-width:60%;">
  {% if scene_image_seed %}
    <p class="mt-2">Seed: {{ scene_image_seed }}</p>
  {% endif %}
{% endif %}

<hr>
<!-- AFFECTION OVERRIDE -->
<form method="POST" class="mb-4">
  <label class="form-label">Override Affection Score:</label>
  <input type="number" step="0.1" class="form-control mb-2" 
         name="affection_new" value="{{ affection_score }}">
  <button type="submit" name="update_affection" class="btn btn-info">
    Update Affection
  </button>
</form>

<hr>
<!-- STAGE UNLOCK TEXT -->
<h3>Stage Unlocks</h3>
<form method="POST" class="mb-4">
  {% for i in range(1,7) %}
    <label>Stage {{ i }} Unlock Text:</label>
    <textarea class="form-control mb-2" rows="2" 
              name="stage_unlock_{{ i }}">{{ stage_unlocks[i] }}</textarea>
  {% endfor %}
  <button type="submit" name="update_stage_unlocks" class="btn btn-warning">
    Save Stage Unlocks
  </button>
</form>

<hr>
<!-- FULL MID-GAME NPC PERSONALIZATION (all fields) -->
<h3>Update NPC Personalizations (Mid-Game)</h3>
<form method="POST" class="row g-3 mb-4">
  <!-- NPC Name -->
  <div class="col-md-6">
    <label class="form-label">NPC Name</label>
    <select class="form-select mb-1" name="npc_name">
      <option value="">--Select--</option>
      {% for nn in npc_name_options %}
        {% if nn == session['npc_name'] %}
          <option value="{{ nn }}" selected>{{ nn }}</option>
        {% else %}
          <option value="{{ nn }}">{{ nn }}</option>
        {% endif %}
      {% endfor %}
    </select>
    {% set name_in_list = session['npc_name'] in npc_name_options %}
    <label>Or custom:</label>
    <input type="text" class="form-control" 
           name="npc_name_custom"
           value="{% if not name_in_list %}{{ session['npc_name'] }}{% endif %}">
  </div>

  <!-- NPC Gender -->
  <div class="col-md-6">
    <label class="form-label">NPC Gender</label>
    <select class="form-select mb-1" name="npc_gender">
      <option value="">--Select--</option>
      {% for gopt in npc_gender_options %}
        {% if gopt == session['npc_gender'] %}
          <option value="{{ gopt }}" selected>{{ gopt }}</option>
        {% else %}
          <option value="{{ gopt }}">{{ gopt }}</option>
        {% endif %}
      {% endfor %}
    </select>
    {% set gender_in_list = session['npc_gender'] in npc_gender_options %}
    <label>Or custom:</label>
    <input type="text" class="form-control"
           name="npc_gender_custom"
           value="{% if not gender_in_list %}{{ session['npc_gender'] }}{% endif %}">
  </div>

  <!-- NPC Age -->
  <div class="col-md-6">
    <label class="form-label">NPC Age</label>
    <select class="form-select mb-1" name="npc_age">
      <option value="">--Select--</option>
      {% for aopt in npc_age_options %}
        {% if aopt == session['npc_age'] %}
          <option value="{{ aopt }}" selected>{{ aopt }}</option>
        {% else %}
          <option value="{{ aopt }}">{{ aopt }}</option>
        {% endif %}
      {% endfor %}
    </select>
    {% set age_in_list = session['npc_age'] in npc_age_options %}
    <label>Or custom:</label>
    <input type="text" class="form-control"
           name="npc_age_custom"
           value="{% if not age_in_list %}{{ session['npc_age'] }}{% endif %}">
  </div>

  <!-- NPC Ethnicity -->
  <div class="col-md-6">
    <label class="form-label">NPC Ethnicity</label>
    <select class="form-select mb-1" name="npc_ethnicity">
      <option value="">--Select--</option>
      {% for eopt in ethnicity_options %}
        {% if eopt == session['npc_ethnicity'] %}
          <option value="{{ eopt }}" selected>{{ eopt }}</option>
        {% else %}
          <option value="{{ eopt }}">{{ eopt }}</option>
        {% endif %}
      {% endfor %}
    </select>
    {% set eth_in_list = session['npc_ethnicity'] in ethnicity_options %}
    <label>Or custom:</label>
    <input type="text" class="form-control"
           name="npc_ethnicity_custom"
           value="{% if not eth_in_list %}{{ session['npc_ethnicity'] }}{% endif %}">
  </div>

  <!-- NPC Body Type -->
  <div class="col-md-6">
    <label class="form-label">NPC Body Type</label>
    <select class="form-select mb-1" name="npc_body_type">
      <option value="">--Select--</option>
      {% for bopt in body_type_options %}
        {% if bopt == session['npc_body_type'] %}
          <option value="{{ bopt }}" selected>{{ bopt }}</option>
        {% else %}
          <option value="{{ bopt }}">{{ bopt }}</option>
        {% endif %}
      {% endfor %}
    </select>
    {% set body_in_list = session['npc_body_type'] in body_type_options %}
    <label>Or custom:</label>
    <input type="text" class="form-control"
           name="npc_body_type_custom"
           value="{% if not body_in_list %}{{ session['npc_body_type'] }}{% endif %}">
  </div>

  <!-- NPC Hair Color -->
  <div class="col-md-6">
    <label class="form-label">NPC Hair Color</label>
    <select class="form-select mb-1" name="npc_hair_color">
      <option value="">--Select--</option>
      {% for hc in hair_color_options %}
        {% if hc == session['npc_hair_color'] %}
          <option value="{{ hc }}" selected>{{ hc }}</option>
        {% else %}
          <option value="{{ hc }}">{{ hc }}</option>
        {% endif %}
      {% endfor %}
    </select>
    {% set hc_in_list = session['npc_hair_color'] in hair_color_options %}
    <label>Or custom:</label>
    <input type="text" class="form-control"
           name="npc_hair_color_custom"
           value="{% if not hc_in_list %}{{ session['npc_hair_color'] }}{% endif %}">
  </div>

  <!-- NPC Hair Style -->
  <div class="col-md-6">
    <label class="form-label">NPC Hair Style</label>
    <select class="form-select mb-1" name="npc_hair_style">
      <option value="">--Select--</option>
      {% for hs in hair_style_options %}
        {% if hs == session['npc_hair_style'] %}
          <option value="{{ hs }}" selected>{{ hs }}</option>
        {% else %}
          <option value="{{ hs }}">{{ hs }}</option>
        {% endif %}
      {% endfor %}
    </select>
    {% set hairst_in_list = session['npc_hair_style'] in hair_style_options %}
    <label>Or custom:</label>
    <input type="text" class="form-control"
           name="npc_hair_style_custom"
           value="{% if not hairst_in_list %}{{ session['npc_hair_style'] }}{% endif %}">
  </div>

  <!-- NPC Personality -->
  <div class="col-md-6">
    <label class="form-label">NPC Personality</label>
    <select class="form-select mb-1" name="npc_personality">
      <option value="">--Select--</option>
      {% for pers in npc_personality_options %}
        {% if pers == session['npc_personality'] %}
          <option value="{{ pers }}" selected>{{ pers }}</option>
        {% else %}
          <option value="{{ pers }}">{{ pers }}</option>
        {% endif %}
      {% endfor %}
    </select>
    {% set pers_in_list = session['npc_personality'] in npc_personality_options %}
    <label>Or custom:</label>
    <input type="text" class="form-control"
           name="npc_personality_custom"
           value="{% if not pers_in_list %}{{ session['npc_personality'] }}{% endif %}">
  </div>

  <!-- NPC Clothing -->
  <div class="col-md-6">
    <label class="form-label">NPC Clothing</label>
    <select class="form-select mb-1" name="npc_clothing">
      <option value="">--Select--</option>
      {% for copt in clothing_options %}
        {% if copt == session['npc_clothing'] %}
          <option value="{{ copt }}" selected>{{ copt }}</option>
        {% else %}
          <option value="{{ copt }}">{{ copt }}</option>
        {% endif %}
      {% endfor %}
    </select>
    {% set cloth_in_list = session['npc_clothing'] in clothing_options %}
    <label>Or custom:</label>
    <input type="text" class="form-control"
           name="npc_clothing_custom"
           value="{% if not cloth_in_list %}{{ session['npc_clothing'] }}{% endif %}">
  </div>

  <!-- NPC Occupation -->
  <div class="col-md-6">
    <label class="form-label">NPC Occupation</label>
    <select class="form-select mb-1" name="npc_occupation">
      <option value="">--Select--</option>
      {% for occ in occupation_options %}
        {% if occ == session['npc_occupation'] %}
          <option value="{{ occ }}" selected>{{ occ }}</option>
        {% else %}
          <option value="{{ occ }}">{{ occ }}</option>
        {% endif %}
      {% endfor %}
    </select>
    {% set occ_in_list = session['npc_occupation'] in occupation_options %}
    <label>Or custom:</label>
    <input type="text" class="form-control"
           name="npc_occupation_custom"
           value="{% if not occ_in_list %}{{ session['npc_occupation'] }}{% endif %}">
  </div>

  <!-- NPC Current Situation -->
  <div class="col-md-6">
    <label class="form-label">NPC Current Situation</label>
    <select class="form-select mb-1" name="npc_current_situation">
      <option value="">--Select--</option>
      {% for cs in current_situation_options %}
        {% if cs == session['npc_current_situation'] %}
          <option value="{{ cs }}" selected>{{ cs }}</option>
        {% else %}
          <option value="{{ cs }}">{{ cs }}</option>
        {% endif %}
      {% endfor %}
    </select>
    {% set cs_in_list = session['npc_current_situation'] in current_situation_options %}
    <label>Or custom:</label>
    <input type="text" class="form-control"
           name="npc_current_situation_custom"
           value="{% if not cs_in_list %}{{ session['npc_current_situation'] }}{% endif %}">
  </div>

  <!-- Environment -->
  <div class="col-md-6">
    <label class="form-label">Environment / Location</label>
    <select class="form-select mb-1" name="environment">
      <option value="">--Select--</option>
      {% for envopt in environment_options %}
        {% if envopt == session['environment'] %}
          <option value="{{ envopt }}" selected>{{ envopt }}</option>
        {% else %}
          <option value="{{ envopt }}">{{ envopt }}</option>
        {% endif %}
      {% endfor %}
    </select>
    {% set env_in_list = session['environment'] in environment_options %}
    <label>Or custom:</label>
    <input type="text" class="form-control"
           name="environment_custom"
           value="{% if not env_in_list %}{{ session['environment'] }}{% endif %}">
  </div>

  <!-- Encounter Context -->
  <div class="col-md-6">
    <label class="form-label">Encounter Context</label>
    <select class="form-select mb-1" name="encounter_context">
      <option value="">--Select--</option>
      {% for ctxopt in encounter_context_options %}
        {% if ctxopt == session['encounter_context'] %}
          <option value="{{ ctxopt }}" selected>{{ ctxopt }}</option>
        {% else %}
          <option value="{{ ctxopt }}">{{ ctxopt }}</option>
        {% endif %}
      {% endfor %}
    </select>
    {% set ctx_in_list = session['encounter_context'] in encounter_context_options %}
    <label>Or custom:</label>
    <input type="text" class="form-control"
           name="encounter_context_custom"
           value="{% if not ctx_in_list %}{{ session['encounter_context'] }}{% endif %}">
  </div>

  <div class="col-12">
    <button type="submit" name="update_npc" value="true" class="btn btn-warning">
      Update NPC
    </button>
  </div>
</form>

<hr>
<!-- Relationship Stats -->
<h3>Relationship Stats</h3>
<ul>
  <li>Affection Score: {{ affection_score }}</li>
  <li>NPC Mood: {{ npc_mood }}</li>
  <li>Current Stage: {{ current_stage }} ({{ stage_label }})</li>
  <li>Stage Description: {{ stage_desc }}</li>
  <li>Next Stage Threshold: {{ next_threshold }}</li>
</ul>

<hr>
<a href="{{ url_for('restart') }}" class="btn btn-outline-secondary">
  Restart Entire Story
</a>
{% endblock %}