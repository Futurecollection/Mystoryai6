{% extends "base.html" %}

{% block content %}
<!-- Loading Spinner (hidden by default) -->
<div id="loading" class="text-center" style="display: none; margin-bottom: 10px;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<!-- Top Navigation -->
<div class="row mb-3">
  <div class="col text-start">
    <a href="{{ url_for('full_story') }}" class="btn btn-info">Full Narration</a>
  </div>
  <div class="col text-end">
    <a href="{{ url_for('logout_route') }}" class="btn btn-danger">Logout</a>
  </div>
</div>

<h1 style="color: #ff5789;">Interaction</h1>

<!-- Scene / Narration -->
<div class="border p-3 mb-3" style="white-space: pre-line; background-color: #4a0d0d; color: #f8d0d0;">
  <strong>Scene:</strong> {{ npc_narration }}
</div>

<!-- USER ACTION FORM -->
<form method="POST" class="mb-4" onsubmit="showLoading()">
  <!-- Quick Action Buttons -->
  <div class="mb-3">
    <button type="button" onclick="prefillAction('OOC: More dialogue')" class="btn btn-outline-info me-2">More Dialogue</button>
    <button type="button" onclick="prefillAction('OOC: More sexually detailed')" class="btn btn-outline-danger me-2">More Sexual Details</button>
    <button type="button" onclick="prefillAction('OOC: More dirty talk')" class="btn btn-outline-warning">More Dirty Talk</button>
  </div>
  <script>
    function prefillAction(text) {
      document.querySelector('input[name="user_action"]').value = text;
    }
    function showLoading() {
      document.getElementById("loading").style.display = "block";
    }
  </script>
  <label class="form-label" style="color: #f8d0d0;">Your Move (in-game):</label>
  <input type="text" class="form-control mb-2" name="user_action" placeholder="He quietly asks how she's doing...">
  <button type="submit" name="submit_action" class="btn btn-success">Send Move</button>
</form>

<hr style="border-top: 1px solid #ff5789;">

<!-- SCENE IMAGE PROMPT FORM -->
<h3 style="color: #ff5789;">Scene Image Prompt</h3>
<form method="POST" class="mb-3" onsubmit="showLoading()">
  <div class="mb-3">
    <button type="submit" name="generate_prompt" class="btn btn-info">Auto Generate Scene Prompt</button>
  </div>

  <textarea name="scene_image_prompt" rows="2" class="form-control" style="background-color: #4a0d0d; color: #f8d0d0;">{{ scene_image_prompt }}</textarea>

  <!-- Model Selection -->
  <div class="mt-2">
    <label class="form-label" style="color: #f8d0d0;">Choose Model:</label>
    <select name="model_type" id="model_type" class="form-control mb-2" style="background-color: #4a0d0d; color: #f8d0d0;">
      <option value="flux">Flux-Schnell</option>
      <option value="pony">Pony-SDXL</option>
      <option value="cyberpony">CyberRealisticPony</option>
      <option value="realistic">Realistic Vision v5.1</option>
    </select>
  </div>

  <!-- Scheduler Dropdown for CyberRealisticPony -->
  <div class="mt-2" id="cyber_scheduler_div" style="display: none;">
    <label class="form-label" style="color: #f8d0d0;">Cyber Pony Scheduler:</label>
    <select name="cyber_scheduler" class="form-control mb-2" style="background-color: #4a0d0d; color: #f8d0d0;">
      <option value="K_EULER">K_EULER</option>
      <option value="KarrasDPM">KarrasDPM</option>
    </select>
  </div>

  <!-- Scheduler Dropdown for Realistic Vision -->
  <div class="mt-2" id="realistic_scheduler_div" style="display: none;">
    <label class="form-label" style="color: #f8d0d0;">Realistic Vision Scheduler:</label>
    <select name="realistic_scheduler" class="form-control mb-2" style="background-color: #4a0d0d; color: #f8d0d0;">
      <option value="EulerA">EulerA</option>
      <option value="MultistepDPM-Solver">MultistepDPM-Solver</option>
    </select>
  </div>

  <!-- Steps Slider (for Pony, CyberPony, and Realistic) -->
  <div class="mt-2" id="steps_div" style="display: none;">
    <label class="form-label" style="color: #f8d0d0;">Number of Steps (20-100):</label>
    <input type="range" class="form-range" min="20" max="100" name="num_steps" value="60" oninput="this.nextElementSibling.value = this.value">
    <output>60</output>
  </div>

  <div class="mt-3">
    <button type="submit" name="generate_image" class="btn btn-primary me-2">Generate Scene Image</button>
    <button type="submit" name="new_seed" class="btn btn-warning">New Seed</button>
  </div>
</form>

{% if scene_image_url %}
  <hr style="border-top: 1px solid #ff5789;">
  <h4 style="color: #ff5789;">Generated Scene Image</h4>
  <img src="{{ url_for('view_image') }}" alt="Scene Image" style="max-width: 60%;">
  {% if scene_image_seed %}
    <p class="mt-2" style="color: #f8d0d0;">Seed: {{ scene_image_seed }}</p>
  {% endif %}
{% endif %}

<hr style="border-top: 1px solid #ff5789;">

<!-- AFFECTION OVERRIDE FORM -->
<form method="POST" class="mb-4" onsubmit="showLoading()">
  <label class="form-label" style="color: #f8d0d0;">Override Affection Score:</label>
  <input type="number" step="0.1" class="form-control mb-2" name="affection_new" value="{{ affection_score }}">
  <button type="submit" name="update_affection" class="btn btn-info">Update Affection</button>
</form>

<hr style="border-top: 1px solid #ff5789;">

<!-- Stage Unlocks Button -->
<div class="row mb-3">
  <div class="col-12">
    <a href="{{ url_for('stage_unlocks') }}" class="btn btn-warning">Edit Stage Unlocks</a>
  </div>
</div>

<hr style="border-top: 1px solid #ff5789;">

<!-- Mid-Game Personalization Button -->
<div class="row mb-3">
  <div class="col-12">
    <a href="{{ url_for('mid_game_personalize') }}" class="btn btn-warning">Update Character & Environment</a>
  </div>
</div>

<hr style="border-top: 1px solid #ff5789;">
<a href="{{ url_for('restart') }}" class="btn btn-outline-secondary">Restart Entire Story</a>

<script>
  // Toggle additional fields based on selected model
  document.getElementById('model_type').addEventListener('change', function() {
    var model = this.value;
    var stepsDiv = document.getElementById('steps_div');
    var cyberDiv = document.getElementById('cyber_scheduler_div');
    var realisticDiv = document.getElementById('realistic_scheduler_div');

    if (model === 'pony' || model === 'cyberpony' || model === 'realistic') {
      stepsDiv.style.display = 'block';
    } else {
      stepsDiv.style.display = 'none';
    }

    if (model === 'cyberpony') {
      cyberDiv.style.display = 'block';
    } else {
      cyberDiv.style.display = 'none';
    }

    if (model === 'realistic') {
      realisticDiv.style.display = 'block';
    } else {
      realisticDiv.style.display = 'none';
    }
  });

  // Trigger initial change event
  document.getElementById('model_type').dispatchEvent(new Event('change'));

  // Show spinner on any form submission
  document.querySelectorAll('form').forEach(function(form) {
    form.addEventListener('submit', function() {
      document.getElementById("loading").style.display = "block";
    });
  });
</script>
{% endblock %}